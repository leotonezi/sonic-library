name: Sonic Library CI

on:
  push:
    branches: [master, development]
  pull_request:
    branches: [master, development]

jobs:
  ci:
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: postgresql+psycopg2://postgres:password@db:5432/fastlibrary
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      NEXT_PUBLIC_BACKEND_URL: http://fastapi:8000

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ³ Set up Docker Compose
        run: docker compose -f docker-compose.yml up -d --build

      - name: â³ Wait for services to become healthy
        run: |
          echo "Waiting for services to be healthy..."
          for i in {1..10}; do
            STATUS=$(docker compose ps | grep "healthy")
            if [ -n "$STATUS" ]; then
              echo "âœ… All services are healthy!"
              break
            fi
            echo "â³ Still waiting... ($i/10)"
            sleep 5
          done

          if [ -z "$STATUS" ]; then
            echo "âŒ Services failed to become healthy."
            docker compose logs
            exit 1
          fi

      - name: ğŸ§ª Run backend tests
        run: docker compose exec -T fastapi pytest

      - name: ğŸ› ï¸ Build frontend
        run: docker compose exec -T frontend npm run build

      - name: ğŸ§¹ Teardown
        if: always()
        run: docker compose down --volumes --remove-orphans

  release:
    if: github.ref == 'refs/heads/master'
    needs: ci
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ§° Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ“¦ Install semantic-release dependencies
        run: npm install

      - name: ğŸš€ Run Semantic Release
        env:
          GH_TOKEN: ${{ secrets.GH_TOKEN }}
        run: npx semantic-release